name: Build

on:
  push:
    branches: [main]
    paths:
      - "**/*.scad"
      - "**/*.plantuml"
      - "**/*.puml"
      - "**/*.asciidoc"
      - ".github/workflows/build.yml"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

env:
  IMG_SCAD: ghcr.io/donnels/openscad:main
  IMG_PUML: ghcr.io/donnels/plantuml:main
  IMG_ADOC: ghcr.io/donnels/asciidoc:main

jobs:
  openscad:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Render OpenSCAD
        run: |
          for f in $(find . -name "*.scad" ! -name "include-*.scad"); do
            dir=$(dirname "$f")
            base=$(basename "$f" .scad)
            docker run --rm -v "$PWD":/w "$IMG_SCAD" \
              openscad -o "/w/${dir}/${base}.stl" "/w/$f" &
            docker run --rm -v "$PWD":/w "$IMG_SCAD" \
              openscad --imgsize 1600,1200 --colorscheme Tomorrow \
              -o "/w/${dir}/${base}.png" "/w/$f" &
            wait
          done
      - name: Commit outputs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A "**/*.{stl,png}"
          git diff --cached --quiet || git commit -m "ci: openscad renders [skip ci]" && git push

  plantuml:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Render PlantUML
        run: |
          for f in $(find . -name "*.plantuml" -o -name "*.puml"); do
            dir=$(dirname "$f")
            docker run --rm -v "$PWD":/w "$IMG_PUML" \
              plantuml -tsvg -o "/w/${dir}" "/w/$f"
            docker run --rm -v "$PWD":/w "$IMG_PUML" \
              plantuml -tpng -o "/w/${dir}" "/w/$f"
          done
      - name: Commit outputs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A "**/*.{svg,png}"
          git diff --cached --quiet || git commit -m "ci: plantuml renders [skip ci]" && git push

  asciidoc:
    runs-on: ubuntu-latest
    needs: [openscad, plantuml]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Pull latest
        run: git pull --rebase
      - name: Build AsciiDoc
        run: |
          mkdir -p docs
          for f in $(find . -name '*.asciidoc'); do
            base=$(basename "$f" .asciidoc)
            docker run --rm -v "$PWD":/w "$IMG_ADOC" \
              asciidoctor -r asciidoctor-diagram -o "/w/docs/${base}.html" "/w/$f"
            docker run --rm -v "$PWD":/w "$IMG_ADOC" \
              asciidoctor-pdf -r asciidoctor-diagram -o "/w/docs/${base}.pdf" "/w/$f"
          done
      - name: Commit docs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/
          git diff --cached --quiet || git commit -m "ci: build docs [skip ci]" && git push
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

  deploy:
    runs-on: ubuntu-latest
    needs: asciidoc
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
