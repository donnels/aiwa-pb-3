name: CAD Build & Publish (entrypoint)

on:
  push:
    paths:
      - "mechanical/**/*.scad"
      - "kicad/**"
      - ".github/workflows/cad-build.yml"
  workflow_dispatch:

permissions:
  contents: write
  packages: read

jobs:
  entry_openscad_render:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/donnels/openscad:main
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - name: Render OpenSCAD assets
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob globstar
          mkdir -p build/openscad
          for file in mechanical/**/*.scad; do
            stem="${file%.scad}"
            slug=$(echo "$stem" | tr '/.' '__')
            openscad -o "build/openscad/${slug}.stl" "$file"
            openscad --imgsize 1600,1200 -o "build/openscad/${slug}.png" "$file"
          done
      - uses: actions/upload-artifact@v4
        with:
          name: openscad-build
          path: build/openscad

  cad_kicad_export:
    runs-on: ubuntu-latest
    needs: entry_openscad_render
    container:
      image: ghcr.io/carrotindustries/docker-kicad:nightly
    steps:
      - uses: actions/checkout@v4
      - name: Export KiCad outputs
        run: |
          mkdir -p build/kicad
          kicad-cli sch export pdf kicad/pb3-replacement.kicad_sch --output build/kicad/pb3-replacement-schematic.pdf
          kicad-cli pcb export svg kicad/pb3-replacement.kicad_pcb --output build/kicad/pb3-replacement-board.svg
      - uses: actions/upload-artifact@v4
        with:
          name: kicad-build
          path: build/kicad

  cad_publish_results:
    runs-on: ubuntu-latest
    needs: cad_kicad_export
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download OpenSCAD artifacts
        uses: actions/download-artifact@v4
        with:
          name: openscad-build
          path: build/openscad
      - name: Download KiCad artifacts
        uses: actions/download-artifact@v4
        with:
          name: kicad-build
          path: build/kicad
      - name: Update generated assets
        run: |
          set -euo pipefail
          mkdir -p docs/generated/openscad docs/generated/kicad
          rsync -a --delete build/openscad/ docs/generated/openscad/
          rsync -a --delete build/kicad/ docs/generated/kicad/
      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/generated
          if git diff --cached --quiet; then
            echo "No generated changes to commit"
          else
            git commit -m "ci: refresh CAD outputs"
            git push
          fi
