name: Build

on:
  push:
    paths:
      - "openscad/**"
      - "kicad/**"
      - "images/**"
      - ".github/workflows/cad-build.yml"
  workflow_dispatch:

permissions:
  contents: write

env:
  IMG_SCAD: ghcr.io/donnels/openscad:main
  IMG_PUML: ghcr.io/donnels/plantuml:main

jobs:
  openscad:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Render
        run: |
          mkdir -p build/openscad
          for f in openscad/*.scad openscad/**/*.scad; do
            [ -f "$f" ] || continue
            [[ "$(basename "$f")" =~ ^include- ]] && continue
            s=$(basename "$f" .scad)
            docker run --rm -v "$PWD":/w "$IMG_SCAD" openscad -o "/w/build/openscad/$s.stl" "/w/$f" &
            docker run --rm -v "$PWD":/w "$IMG_SCAD" openscad --imgsize 1600,1200 --colorscheme Tomorrow -o "/w/build/openscad/$s.png" "/w/$f" &
            wait
          done
      - uses: actions/upload-artifact@v4
        with:
          name: openscad
          path: build/openscad

  plantuml:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Render
        run: |
          mkdir -p build/plantuml
          for f in images/*.puml images/*.plantuml; do
            [ -f "$f" ] || continue
            docker run --rm -v "$PWD":/w "$IMG_PUML" plantuml -tsvg -o /w/build/plantuml "/w/$f"
            docker run --rm -v "$PWD":/w "$IMG_PUML" plantuml -tpng -o /w/build/plantuml "/w/$f"
          done
      - uses: actions/upload-artifact@v4
        with:
          name: plantuml
          path: build/plantuml

  kicad:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: INTI-CMNB/KiBot@v2_dk8
        with:
          config: kicad/kibot.yaml
          schema: kicad/pb3-replacement.kicad_sch
          board: kicad/pb3-replacement.kicad_pcb
          dir: build/kicad
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: kicad
          path: build/kicad

  publish:
    runs-on: ubuntu-latest
    needs: [openscad, plantuml, kicad]
    if: always()
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/download-artifact@v4
        with:
          path: build
      - name: Sync to source dirs
        run: |
          [ -d build/openscad ] && rsync -a build/openscad/ openscad/ || true
          [ -d build/plantuml ] && rsync -a build/plantuml/ images/ || true
          [ -d build/kicad ] && rsync -a build/kicad/ kicad/ || true
      - name: Generate image indexes
        run: |
          # OpenSCAD directory
          {
            echo "= OpenSCAD Renders"
            cat includes/include-toc-standalone.adoc
            echo ""
            for f in openscad/*.png; do
              [ -f "$f" ] || continue
              base=$(basename "$f" .png)
              echo "== $base"
              echo ""
              echo ".\`$base\`"
              echo "image::$base.png[]"
              echo ""
              [ -f "openscad/$base.stl" ] && echo "link:$base.stl[Download STL]" && echo ""
            done
          } > openscad/README.adoc
          
          # Images directory
          {
            echo "= PlantUML Diagrams"
            cat includes/include-toc-standalone.adoc
            echo ""
            for f in images/*.svg; do
              [ -f "$f" ] || continue
              base=$(basename "$f" .svg)
              echo "== $base"
              echo ""
              echo ".\`$base\`"
              # Prefer PNG for display, link to SVG
              if [ -f "images/$base.png" ]; then
                echo "image::$base.png[]"
              else
                echo "image::$base.svg[]"
              fi
              echo ""
              [ -f "images/$base.svg" ] && echo "link:$base.svg[SVG] " || true
              [ -f "images/$base.png" ] && echo "link:$base.png[PNG]" || true
              echo ""
            done
          } > images/README.adoc
      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add openscad/*.{stl,png} images/*.{svg,png} kicad/*.{pdf,svg} || true
          git add openscad/README.adoc images/README.adoc || true
          git diff --cached --quiet || git commit -m "ci: refresh outputs [skip ci]" && git push
